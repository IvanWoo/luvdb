{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}
    Sign Up
{% endblock title %}
{% block content %}
    <div class="container">
        <div class="row">
            <!-- Left column -->
            <div class="col-12 col-md-7 left-column">
                <h2>Sign Up</h2>
                {% if invite_code_used %}
                    This invitation code has already been used.
                {% else %}
                    {% if inviter %}
                        <div class="fs-4 mb-3">
                            {% if inviter.is_public %}
                                <a href="{% url 'accounts:detail' inviter.username%}">{{inviter.display_name|default:inviter.username}} </a>
                            {% else %}
                                {{inviter.display_name|default:inviter.username}} 
                            {% endif %}
                            is inviting you to join LÊŒvDB.</div>
                    {% endif %}
                    {% if not user.is_authenticated %}
                        <form method="post">
                            {% csrf_token %}
                            {{ form.invitation_code|as_crispy_field }}
                            {{ form.username |as_crispy_field }}
                            {{ form.signup_method|as_crispy_field }}
                            {{ form.password1|as_crispy_field }}
                            {{ form.password2|as_crispy_field }}
                            <div id="passkeySupportWarning" class="alert alert-warning" style="display: none;">
                                Your browser does not support passkeys. Please choose "Password Only" or contact support.
                            </div>
                            <button type="submit" class="btn btn-primary" id="signupSubmitButton">Sign Up</button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
                const form = document.querySelector("form");
                const signupMethodField = document.querySelector("#id_signup_method");
                const passwordFields = [
                    document.querySelector("#id_password1"),
                    document.querySelector("#id_password2")
                ];
            
                function adjustFormBasedOnSignupMethod() {
                    const method = signupMethodField.value;
                    if (method === "passkey") {
                        // Hide and disable password fields if "Passkey Only" is selected
                        passwordFields.forEach(field => {
                            field.parentNode.style.display = 'none'; // Hide container
                            field.required = false; // Disable required validation
                        });
                    } else {
                        // Show and enable password fields for "Password Only" or "Both"
                        passwordFields.forEach(field => {
                            field.parentNode.style.display = 'block'; // Show container
                            field.required = true; // Enable required validation
                        });
                    }
                }
            
                signupMethodField.addEventListener("change", adjustFormBasedOnSignupMethod);
                adjustFormBasedOnSignupMethod(); // Call initially to set the correct state
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const authMethodField = document.querySelector('select[name="signup_method"]'); // Assuming this is a <select>
            const submitButton = document.getElementById('signupSubmitButton'); // Targeting by ID        
            
            function supportsPasskeys() {
                return navigator.credentials && navigator.credentials.create;
                // return false; // for debug
            }
        
            function adjustFormBasedOnAuthMethod() {
                const method = authMethodField.value;
                const isPasskeySupported = supportsPasskeys();
                if (method === "passkey" && !isPasskeySupported) {
                    document.getElementById('passkeySupportWarning').style.display = 'block';
                    submitButton.disabled = true; // Disable the submit button if passkey is selected but not supported
                } else {
                    document.getElementById('passkeySupportWarning').style.display = 'none';
                    submitButton.disabled = false;
                    console.log(submitButton)
                }
            }
        
            if (authMethodField) {
                authMethodField.addEventListener("change", adjustFormBasedOnAuthMethod);
                adjustFormBasedOnAuthMethod(); // Initial check
            }
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const signupMethodSelect = document.getElementById('id_signup_method');
            const signupMethodHelpText = document.getElementById('id_signup_method_helptext');
        
            function updateSignupMethodHelpText() {
                const method = signupMethodSelect.value;
                let helpText = '';
                if (method === 'password') {
                    helpText = 'Passwords are traditional but require you to remember them. Consider using a strong, unique password for security.';
                } else if (method === 'passkey') {
                    helpText = "Passkeys allow you to sign in safely and easily, without requiring a password and two-factor authentication. <a href='https://passkey.dev'>What is a passkey?</a>";
                } else if (method === 'both') {
                    helpText = 'Choosing both allows you the flexibility of using either a passkey or a password. This can be convenient if you later log in through devices that do not support passkeys.';
                }
                signupMethodHelpText.innerHTML = helpText;
            }
        
            // Listen for changes to the signup method select field
            signupMethodSelect.addEventListener('change', updateSignupMethodHelpText);
        
            // Initialize help text based on the current selection
            updateSignupMethodHelpText();
        });
        </script>
        
        
    <style>
        .readonly-field {
            background-color: var(--bg-highlight) !important;
            border: none;
        }
    </style>

{% endblock content %}
