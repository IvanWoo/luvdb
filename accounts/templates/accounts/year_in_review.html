{% extends "base.html" %}
{% load markdownify %}
{% load account_tags %}
{% load util_filters %}
{% load linkify %}
{% block content %}

<div class="container">
    <div class="row justify-content-start">
        <div class="col-12 col-md-8 order-2 order-md-1">
            <h1>{{user.display_name|default:user.username}}'s Year in Review {{requested_year}} on LʌvDB</h1>
            {% if if_data_available %}
                {% if requested_year < 2023 %}
                    LʌvDB didn't exist in {{requested_year}}. 
                {% endif %}
                {% if total_writing %}
                <div class="fs-4 fw-bold mt-3">Writing</div>
                <div>
                    In the year {{requested_year}}, 
                    {{user.display_name|default:user.username}}
                    wrote
                    <ul class="mt-2">
                        {% if comments %}<li>{{comments}} comments</li>{% endif %}  
                        {% if says %}<li>{{says}} says</li>{% endif %}  
                        {% if reposts %}<li>{{reposts}} reposts</li>{% endif %}  
                        {% if posts %}<li>{{posts}} posts</li>{% endif %} 
                        {% if pins %}<li>{{pins}} pins</li>{% endif %}    
                    </ul>

                    {% if luvlists_created %}
                    <div>
                        and curated {{luvlists_created}} Lists.
                    </div>
                    {% endif %}
                </div>

                {% endif %}

                {% if total_checkins %}
                    <div class="fs-4 fw-bold mt-3">Check-ins</div>
                    <div>
                        In the year {{requested_year}}, 
                        {{user.display_name|default:user.username}}
                        checked in {{total_checkins}} times to:
                    </div>
                    <div class="mt-2">
                        <ul>
                            {% if books_checked_in %}
                                <li>{{books_checked_in}} books 
                                    <ul>
                                        <li>{{books_to_read}} to-read</li>
                                        <li>{{books_reading}} reading / {{books_rereading}} rereading</li>
                                        <li>{{books_read}} read / {{books_reread}} reread</li>
                                        <li>{{books_paused}} paused / {{books_abandoned}} abandoned</li>
                                    </ul>
                                </li>
                            {% endif %}
                            {% if audiobooks_checked_in %}
                                <li>{{audiobooks_checked_in}} audiobooks
                                    <ul>
                                        <li>{{audiobooks_to_listen}} to-listen</li>
                                        <li>{{audiobooks_listening}} listening / {{audiobooks_relistening}}</li>
                                        <li>{{audiobooks_listened}} listened / {{audiobooks_relistened}} relistened</li>
                                        <li>{{audiobooks_paused}} paused / {{audiobooks_abandoned}} abandoned</li>
                                    </ul>
                                </li>
                            {% endif %}
                            {% if movies_checked_in %}
                                <li>{{movies_checked_in}} movies 
                                    <ul>
                                        <li>{{movies_to_watch}} to-watch</li>
                                        <li>{{movies_watching}} watching / {{movies_rewatching}} rewatching</li>
                                        <li>{{movies_watched}} watched / {{movies_rewatched}} rewatched</li>
                                        <li>{{movies_paused}} paused / {{movies_abandoned}} abandoned</li>
                                    </ul>
                                </li>
                            {% endif %}
                            {% if series_checked_in %}
                                <li>{{series_checked_in}} series
                                    <ul>
                                        <li>{{series_to_watch}} to-watch </li>
                                        <li>{{series_watching}} watching / {{series_rewatching}} rewatching </li>
                                        <li>{{series_watched}} watched / {{series_rewatched}} rewatched </li>
                                        <li>{{series_paused}} paused / {{series_abandoned}} abandoned </li>  
                                    </ul>                               
                                </li>
                            {% endif %}
                            {% if releases_checked_in %}
                                <li>{{releases_checked_in}} albums or singles
                                    <ul>
                                        <li>{{releases_to_listen}} to-listen</li>
                                        <li>{{releases_looping}} looping</li>
                                        <li>{{releases_listened}} listened / {{releases_relistened}} relistened</li>
                                        <li>{{releases_abandoned}} abandoned</li>
                                    </ul>
                                </li>
                            {% endif %}
                            {% if podcasts_checked_in %}
                                <li>{{podcasts_checked_in}} podcast
                                    <ul>
                                        <li>{{podcasts_to_listen}} to-listen</li>
                                        <li>{{podcasts_sampled}} sampled</li>
                                        <li>{{podcasts_subscribed}} subscribed</li>
                                        <li>{{podcasts_unsubscribed}} unsubscribed</li>
                                    </ul>
                                </li>
                            {% endif %}
                            
                            {% if games_checked_in %}
                                <li>{{games_checked_in}} games
                                    <ul>
                                        <li>{{games_to_play}} to-play </li>
                                        <li>{{games_playing}} playing / {{games_replaying}} replaying </li>
                                        <li>{{games_played}} played / {{games_replayed}} replayed </li>
                                        <li>{{games_paused}} paused / {{games_abandoned}} abandoned </li>
                                    </ul>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                
                {% endif %}
                
                {% if total_contribution %}
                    <div class="fs-4 fw-bold mt-3">Contributions</div>
                    <div>
                        In the year {{requested_year}}, 
                        {{user.display_name|default:user.username}}
                        contributed a total of {{total_contribution}} entries to LʌvDB.
                    </div>
                    <div class="mt-2">
                        {% if contributed_litworks > 0 or contributed_litinstances > 0 or contributed_books > 0 %}
                        <div class="fs-5 fw-semibold mt-2">Read</div>
                        <ul>
                            {% if contributed_litworks > 0 %}<li>{{contributed_litworks}} Works</li>{% endif %}
                            {% if contributed_litinstances > 0 %}<li>{{contributed_litinstances}} Instances</li>{% endif %}
                            {% if contributed_books > 0 %}<li>{{contributed_books}} Books</li>{% endif %}
                        </ul>
                        {% endif %}
                        {% if contributed_movies > 0 or contributed_series > 0 %}
                        <div class="fs-5 fw-semibold mt-2">Watch</div>
                        <ul>
                            {% if contributed_movies > 0 %}<li>{{contributed_movies}} Movies</li>{% endif %}
                            {% if contributed_series > 0 %}<li>{{contributed_series}} Series</li>{% endif %}
                        </ul>
                        {% endif %}
                        {% if contributed_musicworks > 0 or contributed_tracks > 0 or contributed_release > 0 %}
                        <div class="fs-5 fw-semibold mt-2">Listen</div>
                        <ul>
                            {% if contributed_musicworks > 0 %}<li>{{contributed_musicworks}} Works</li>{% endif %}
                            {% if contributed_tracks > 0 %}<li>{{contributed_tracks}} Tracks</li>{% endif %}
                            {% if contributed_releases > 0 %}<li>{{contributed_releases}} Releases</li>{% endif %}
                            {% if contributed_audiobooks > 0 %}<li>{{contributed_audiobooks}} Audiobooks</li>{% endif %}
                        </ul>
                        {% endif %}
                        {% if contributed_gameworks > 0 or contributed_games > 0 %}
                        <div class="fs-5 fw-semibold mt-2">Play</div>
                        <ul>
                            {% if contributed_gameworks > 0 %}<li>{{contributed_gameworks}} Works</li>{% endif %}
                            {% if contributed_games > 0 %}<li>{{contributed_games}} Games</li>{% endif %}
                        </ul>
                        {% endif %}
                    </div>
                    <div>
                        Thank you for your contributions!
                    </div>
                {% endif %}
            {% else %}
                <p>Stats for year {{requested_year}} will be available on December 25th.</p>
            {% endif %}

            <hr class="mt-3">
            <div class="year-selector">
                {% for year in all_years %}
                    <a href="{% url 'accounts:year_in_review_by_year' username=user.username year=year %}">{{ year }}</a>
                {% endfor %}
            </div>
        </div>

        <div class="col-12 col-md-4 mb-1 order-1 order-md-2">
            <div class="bio p-3 bg-light">
                <div class="align-items-center">
                    {% if object.display_name %}
                        <span>
                            {{ object.display_name }}
                        </span>
                    {% endif %}
                    <a href="https://luvdb.com{% url 'accounts:detail' object.username %}">
                        @{{ object.username }}
                    </a>
                    {% if not object.is_public %}
                        <svg class="mb-1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" title="This profile is not public" aria-label="This profile is not public">
                            <path d="M 12 1 C 8.6761905 1 6 3.6761905 6 7 L 6 8 C 4.9 8 4 8.9 4 10 L 4 20 C 4 21.1 4.9 22 6 22 L 18 22 C 19.1 22 20 21.1 20 20 L 20 10 C 20 8.9 19.1 8 18 8 L 18 7 C 18 3.6761905 15.32381 1 12 1 z M 12 3 C 14.27619 3 16 4.7238095 16 7 L 16 8 L 8 8 L 8 7 C 8 4.7238095 9.7238095 3 12 3 z M 12 13 C 13.1 13 14 13.9 14 15 C 14 16.1 13.1 17 12 17 C 10.9 17 10 16.1 10 15 C 10 13.9 10.9 13 12 13 z"></path>
                        </svg>
                    {% endif %}
                </div>
                <p>
                    <span class="text-muted">Since {{ object.date_joined|date:"Y.m.d" }}</span>
                </p>
                {% if object.bio %}
                    <div>{{ object.bio | linkify_tags | markdownify }}</div>
                {% endif %}
                {% if object == request.user %}
                    <div class='d-flex'>
                        <!-- Action buttons -->
                        <a class="btn btn-primary btn-sm mt-3 me-1"
                        href="{% url 'accounts:update' object.username %}"
                        role="button">Update Profile</a>
                        <div class="dropdown mt-3">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                    type="button"
                                    id="actionMenu"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">More</button>
                            <ul class="dropdown-menu" aria-labelledby="actionMenu">
                                {% if object.is_staff %}
                                <li>
                                    <a class="dropdown-item"
                                        href="{% url 'manage_invitation_requests' %}"
                                        role="button">Manage Invite Requests</a>
                                </li>
                                {% endif %}
                                <li>
                                    <a class="dropdown-item"
                                    href="{% url 'accounts:manage_invitations' object.username %}"
                                    role="button">Invite friends</a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                    href="{% url 'accounts:app_password' object.username %}"
                                    role="button">Manage App Passwords</a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                    href="{% url 'accounts:crossposters' object.username %}"
                                    role="button">Manage Crossposters</a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                    href="{% url 'accounts:export_user_data' object.username %}"
                                    role="button">Export Your Data</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
                {% if object != request.user %}
                    <div class='d-flex'>
                        {% if not request.user|is_blocking:object %}
                            {% if request.user|is_following:object %}
                                <form method="POST" action="{% url 'activity_feed:unfollow' object.id %}">
                                    {% csrf_token %}
                                    <button class="btn btn-primary btn-sm mt-3 me-1" type="submit">Unfollow</button>
                                </form>
                            {% else %}
                                <form method="POST" action="{% url 'activity_feed:follow' object.id %}">
                                    {% csrf_token %}
                                    <button class="btn btn-primary btn-sm mt-3 me-1" type="submit">Follow</button>
                                </form>
                            {% endif %}
                        {% endif %}
                        <div class="dropdown mt-3">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                    type="button"
                                    id="actionMenu"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">More</button>
                            <ul class="dropdown-menu" aria-labelledby="actionMenu">
                                {% if request.user|is_blocking:object %}
                                    <li>
                                        <form method="POST" action="{% url 'activity_feed:unblock' object.id %}">
                                            {% csrf_token %}
                                            <button class="dropdown-item" type="submit">Unblock</button>
                                        </form>
                                    </li>
                                {% else %}
                                    <li>
                                        <form method="POST" action="{% url 'activity_feed:block' object.id %}">
                                            {% csrf_token %}
                                            <button class="dropdown-item" type="submit">Block</button>
                                        </form>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
            <hr>
        </div>

    </div>
</div>

{% endblock%}