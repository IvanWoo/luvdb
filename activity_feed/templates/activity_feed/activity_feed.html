{% extends "base.html" %}
{% load url_filters %}
{% load markdownify %}
{% load linkify %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-7 left-column">
                {% if feed_type == "public" %}
                    <span style="display: flex;">
                        <p style="padding-right:0.5em">Say</p>
                        |
                        <a href="{% url 'write:post_create' %}">
                            <p style="padding: 0 0.5em">Post</p>
                        </a> |
                        <a href="{% url 'write:pin_create' %}">
                            <p style="padding: 0 0.5em">Pin</p>
                        </a>
                    </span>
                    <form method="post">
                        {% csrf_token %}
                        {{ say_form.content|as_crispy_field }}
                        <span class="d-flex justify-content-between mb-0">
                            <button type="submit" class="btn btn-primary btn-sm " style="height: 30px">Add Say</button>
                            <div class="mb-0">{{ say_form.comments_enabled|as_crispy_field }}</div>
                        </span>
                    </form>
                {% elif feed_type == "personal" %}
                    <h3>{{ feed_user.display_name | default:feed_user.username }}'s Feed</h3>
                {% endif %}
                {% include "activity_feed/activity_filter.html" %}
                {% for activity in page_obj %}
                    {% include "activity_feed/activity_item.html" with width='wide' %}
                {% endfor %}
                {% if page_obj.paginator.num_pages > 1 %}
                    <hr>
                    <div class="pagination">
                        <span class="step-links">
                            {% for i in page_obj.paginator.page_range %}
                                {% if page_obj.number == i %}
                                    <span class="current">{{ i }}</span>
                                {% else %}
                                    <a href="?page={{ i }}">{{ i }}</a>
                                {% endif %}
                            {% endfor %}
                        </span>
                    </div>
                {% endif %}
            </div>
            {% if feed_type == "public" %}
                <div class="col-12 col-md-5 right-column">
                    <div class='bg-light p-3 mb-3'>
                        {% now "Y-m-d" as current_date %}
                        <h5>On This Day ({{ current_date|slice:"5:10" }})</h5>
                        {% if current_date|slice:"5:10" == "06-10" %}
                            {% now "Y" as current_year %}
                            <div class="alert alert-success" role="alert">LÊŒvDB is {{ current_year|add:"-2023" }} years old today!</div>
                        {% endif %}
                        {% if not books_published_today and not movies_released_today and not series_released_today and not music_released_today and not games_released_today and not born_today and not died_today %}
                            <p>Looks like it's a quiet day in our database.</p>
                        {% else %}
                            {% if books_published_today %}
                                <div class="card mb-3">
                                    <div class="card-header"
                                         id="booksHeading"
                                         data-bs-toggle="collapse"
                                         data-bs-target="#booksCollapse"
                                         role="button"
                                         aria-expanded="false"
                                         aria-controls="booksCollapse">
                                        <b>Books</b>
                                    </div>
                                    <div id="booksCollapse" class="collapse" aria-labelledby="booksHeading">
                                        <ul class="list-group list-group-flush">
                                            {% for book in books_published_today %}
                                                <li class="list-group-item">
                                                <span><a href="{% url 'read:book_detail' book.id %}">{{ book.title }}</a>
                                                {% if book.subtitle %}: {{ book.subtitle }}{% endif %}
                                            </span>
                                            {# djlint:off #}
                                            ({{ book.publication_date|slice:":4" }}{% if book.since == 0 %}, today{% else %}, {{ book.since }} years ago{% endif %})
                                            {# djlint:on #}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                    {% if movies_released_today or series_released_today %}
                        <div class="card mb-3">
                            <div class="card-header"
                                 id="moviesSeriesHeading"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#moviesSeriesCollapse"
                                 role="button"
                                 aria-expanded="false"
                                 aria-controls="moviesSeriesCollapse">
                                <b>Movies / Series</b>
                            </div>
                            <div id="moviesSeriesCollapse"
                                 class="collapse"
                                 aria-labelledby="moviesSeriesHeading">
                                <ul class="list-group list-group-flush">
                                    {% for movie in movies_released_today %}
                                        <li class="list-group-item">
                                            <a href="{% url 'watch:movie_detail' movie.id %}">{{ movie.title }}</a>
                                            {# djlint:off #}
                                            ({{ movie.release_date|slice:":4" }}{% if movie.since == 0 %}, today{% else %}, {{ movie.since }} years ago{% endif %})
                                            {# djlint:on #}
                                        </li>
                                    {% endfor %}
                                    {% for serie in series_released_today %}
                                        <li class="list-group-item">
                                            <a href="{% url 'watch:series_detail' serie.id %}">{{ serie.title }}</a>
                                            {# djlint:off #}
                                            ({{ serie.release_date|slice:":4" }}{% if serie.since == 0 %}, today{% else %}, {{ serie.since }} years ago{% endif %})
                                            {# djlint:on #}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                    {% if music_released_today %}
                        <div class="card mb-3">
                            <div class="card-header"
                                 id="musicHeading"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#musicCollapse"
                                 role="button"
                                 aria-expanded="false"
                                 aria-controls="musicCollapse">
                                <b>Music</b>
                            </div>
                            <div id="musicCollapse" class="collapse" aria-labelledby="musicHeading">
                                <ul class="list-group list-group-flush">
                                    {% for music in music_released_today %}
                                        <li class="list-group-item">
                                            <a href="{% url 'listen:release_detail' music.id %}">{{ music.title }}</a>
                                            {# djlint:off #}
                                            ({{ music.release_date|slice:":4" }}{% if music.since == 0 %}, today{% else %}, {{ music.since }} years ago{% endif %})
                                            {# djlint:on #}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                    {% if games_released_today %}
                        <div class="card mb-3">
                            <div class="card-header"
                                 id="gamesHeading"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#gamesCollapse"
                                 role="button"
                                 aria-expanded="false"
                                 aria-controls="gamesCollapse">
                                <b>Games</b>
                            </div>
                            <div id="gamesCollapse" class="collapse" aria-labelledby="gamesHeading">
                                <ul class="list-group list-group-flush">
                                    {% for game in games_released_today %}
                                        <li class="list-group-item">
                                            <a href="{% url 'play:game_detail' game.id %}">{{ game.title }}</a>
                                            {# djlint:off #}
                                            ({{ game.release_date|slice:":4" }}{% if game.since == 0 %}, today{% else %}, {{ game.since }} years ago{% endif %})
                                            {# djlint:on #}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                    {% if born_today or died_today %}
                        <div class="card mb-3">
                            <div class="card-header"
                                 id="personsHeading"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#personsCollapse"
                                 role="button"
                                 aria-expanded="false"
                                 aria-controls="personsCollapse">
                                <b>Persons</b>
                            </div>
                            <div id="personsCollapse"
                                 class="collapse"
                                 aria-labelledby="personsHeading">
                                <ul class="list-group list-group-flush">
                                    {% if born_today %}
                                        <li class="list-group-item">
                                            <b>Born</b>
                                        </li>
                                        {% for person in born_today %}
                                            <li class="list-group-item">
                                                {# djlint:off #}
                                                <a href="{% url 'entity:person_detail' person.id %}">{{ person.name }}</a>
                                                ({{ person.birth_date|slice:":4" }}{% if person.death_date %}-{{ person.death_date|slice:":4" }}{% else %} - {% endif %}, {{ person.since }} years ago)
                                                {# djlint:on #}
                                            </li>
                                        {% endfor %}
                                    {% endif %}
                                    {% if died_today %}
                                        <li class="list-group-item">
                                            <b>Died</b>
                                        </li>
                                        {% for person in died_today %}
                                            <li class="list-group-item">
                                                <a href="{% url 'entity:person_detail' person.id %}">{{ person.name }}</a>
                                                {# djlint:off #}
                                                ({% if person.birth_date %}{{ person.birth_date|slice:":4" }}{% else %}?{% endif %}-{{ person.death_date|slice:":4" }}, {{ person.since }} years ago)
                                                {# djlint:on #}
                                            </li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
</div>
<script>
    function smartTruncate(str, maxLength) {
        if (str.length <= maxLength) return str;
    
        if (str.includes(" ")) {
            let truncated = str.substr(0, maxLength);
            return truncated.substr(0, Math.min(truncated.length, truncated.lastIndexOf(' ')));
        } else {
            return str.substr(0, maxLength);
        }
    }
    
    function getOpenTags(html) {
        const regex = /<([a-z]+)(?=[\s>])[^<]*?(?<!\/)>/gi;
        const closingTagsRegex = /<\/([a-z]+)>/gi;
        const result = [];
        let match;
        
        while (match = regex.exec(html)) {
            result.push(match[1]);
        }
        
        while (match = closingTagsRegex.exec(html)) {
            const closeTagName = match[1];
            const index = result.lastIndexOf(closeTagName);
            if (index !== -1) {
                result.splice(index, 1);
            }
        }
        
        return result;
    }
    
    function getHtmlTruncationPoint(html, plainTextTruncationPoint) {
        // Start from the plainTextTruncationPoint
        let point = plainTextTruncationPoint;
    
        // Move the point forward until a "<" character is found or until we've checked the entire string
        while (point < html.length && html[point] !== '<') {
            point++;
        }
        
        // If we've reached the end of the string without finding a "<", return the original plainTextTruncationPoint
        return (point === html.length) ? plainTextTruncationPoint : point;
    }

    document.addEventListener("DOMContentLoaded", function() {
        const threshold = 300;
        const elements = document.querySelectorAll('.truncatable-text');
    
        elements.forEach(el => {
            const paragraphs = Array.from(el.querySelectorAll('p'));
            let totalChars = 0;
            let breakAtParagraphIndex = -1;
            let breakAtCharIndex = -1;
    
            for (let i = 0; i < paragraphs.length; i++) {
                totalChars += paragraphs[i].textContent.length;
                if (totalChars > threshold && breakAtParagraphIndex === -1) {
                    breakAtParagraphIndex = i;
                    breakAtCharIndex = threshold - (totalChars - paragraphs[i].textContent.length);
                }
            }
    
            if (breakAtParagraphIndex !== -1) {
                const paragraph = paragraphs[breakAtParagraphIndex];
                const truncatedText = smartTruncate(paragraph.textContent, breakAtCharIndex);
                const originalHTML = paragraph.innerHTML;
    
                const truncatePosInPlainText = paragraph.textContent.lastIndexOf(truncatedText) + truncatedText.length;
                const truncatePosInHTML = getHtmlTruncationPoint(originalHTML, truncatePosInPlainText);
    
                const preHTML = originalHTML.substr(0, truncatePosInHTML);
                const postHTML = originalHTML.substr(truncatePosInHTML);
    
                const openTags = getOpenTags(preHTML);
                const closeTags = openTags.map(tag => `</${tag}>`).reverse().join('');
                const openTagsStr = openTags.map(tag => `<${tag}>`).join('');
    
                paragraph.innerHTML = `${preHTML}${closeTags}<span class="truncated-ellipsis">...</span><span class="truncated-more-content" style="display: none;">${openTagsStr}${postHTML}</span>`;
                
                // Wrap the following paragraphs in a div
                const moreContentDiv = document.createElement('div');
                moreContentDiv.classList.add('truncated-more-content');
                moreContentDiv.style.display = 'none';

                for (let i = breakAtParagraphIndex + 1; i < paragraphs.length; i++) {
                    moreContentDiv.appendChild(paragraphs[i].cloneNode(true)); // Append a copy of the paragraph to the div
                    paragraphs[i].remove(); // Remove the original paragraph from the DOM
                }
                
                el.appendChild(moreContentDiv);
    
                const showMoreLink = document.createElement('a');
                showMoreLink.href = "javascript:void(0);";
                showMoreLink.textContent = '(Show More)';
                showMoreLink.classList.add('show-more-link');
                el.appendChild(showMoreLink);
    
                showMoreLink.addEventListener('click', function() {
                    const moreContentElems = el.querySelectorAll('.truncated-more-content');
                    const ellipsisElem = el.querySelector('.truncated-ellipsis');
                                    
                    if (this.textContent === '(Show More)') {
                        moreContentElems.forEach(elem => {
                            elem.style.display = elem.tagName === 'DIV' ? 'block' : 'inline'; // Display div as block and spans as inline
                        });
                        ellipsisElem.style.display = 'none';
                        this.textContent = '(Show Less)';
                    } else {
                        moreContentElems.forEach(elem => {
                            elem.style.display = 'none';
                        });
                        ellipsisElem.style.display = 'inline';
                        this.textContent = '(Show More)';
                    }
                });
            }
        });
    });
    
</script>
<style>
    .show-more-link {
        color: #657786; 
        cursor: pointer;
        text-decoration: none;
    }
</style>
{% endblock %}
