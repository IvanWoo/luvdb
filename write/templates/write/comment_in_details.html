{% load markdownify %}
{% load linkify %}
{% load crispy_forms_tags %}

{% if comments %}
  {% for comment in comments %}
    <div class="mb-3">
      <span class='d-flex'>
        <a href="{% url 'accounts:detail' comment.author.username%}" class="me-2">
          {{ comment.author.display_name | default:comment.author.username }}
        </a>
        <p class='me-2 text-secondary'>{{comment.timestamp | date:"Y.m.d H:i"}} </p>
        <a href="#" class="quote-link me-2" data-comment="{{ comment.content }}" data-author="{{ comment.author.display_name | default:comment.author.username }}" data-timestamp="{{comment.timestamp | date:'Y.m.d H:i'}}">Quote</a>        {% if comment.author == request.user %} 
        <a href="{% url "write:comment_update" comment.pk %}" class="me-2">Edit</a>
        {% endif %}
        {% if object.author == request.user or comment.author == request.user %} 
          <a href="{% url "write:comment_delete" comment.pk %}" class="me-2">Delete</a>
        {% endif %}
      </span>
      <div class="bg-light p-3">{{ comment.content| linkify_tags | linkify_mentions | markdownify }}</div>
    </div>
  {% empty %}
    <p>No comments yet.</p>
  {% endfor %}
  <hr>
{% endif %}

{% if object.comments_enabled %}
  <form method="POST" action="{% url 'write:comment_create' 'write' object_type object.id %}" id="comment-form">
    {% csrf_token %}
    {{ comment_form|crispy }}
    <button type="submit" class='btn btn-sm btn-primary'>Add Comment</button>
  </form>
  <br>
{% else %}
  <p>Comment disabled.</p>
{% endif %} 

<script>
  document.querySelectorAll('.quote-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      var comment = this.getAttribute('data-comment');
      var author = this.getAttribute('data-author');
      var timestamp = this.getAttribute('data-timestamp');
      var commentForm = document.getElementById('comment-form');
      var textarea = commentForm.querySelector('textarea');
      textarea.value = '> ' + author + ' (' + timestamp + ')\n> ' + comment.replace(/\n/g, '\n> ') + '\n\n';
      textarea.focus();
    });
  });
</script>





